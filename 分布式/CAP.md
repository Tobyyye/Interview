cap 是指什么？mysql 满足 cap 中哪些？

https://zhuanlan.zhihu.com/p/98393679

 ![彻底搞清楚什么是CAP理论？](https://pic2.zhimg.com/v2-d4ab4a0fddd3d8b4c48a04e69e10835f_1440w.jpg?source=172ae18b) 



https://juejin.cn/post/6895761455358935053#heading-12

### 1、理解CAP

 CAP是 Consistency、Availability、Partition tolerance三个词语的缩写，分别表示一致性、可用性、分区容忍性。

在理论计算机科学中，CAP定理（CAP theorem），又被称作布鲁尔定理（Brewer's theorem），它指出对于一个分布式计算系统来说，不可能同时满足以下三点：

- 一致性（Consistency） （等同于所有节点访问同一份最新的数据副本）
- 可用性（Availability）（每次请求都能获取到非错的响应——但是不保证获取的数据为最新数据）
- 分区容错性（Partition tolerance）（以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择）



下边我们分别来解释：

 为了方便对CAP理论的理解，我们结合电商系统中的一些业务场景来理解CAP。

 如下图，是商品信息管理的执行流程：

 ![img](https://pic3.zhimg.com/80/v2-df21cb43ed0a6148cc69d50bee93b256_720w.jpg) 



整体执行流程如下：

 1、商品服务请求主数据库写入商品信息（添加商品、修改商品、删除商品）

 2、主数据库向商品服务响应写入成功。

 3、商品服务请求从数据库读取商品信息。



**C - Consistency**：

- C-一致性：外部访问任意一个节点，获取的数据都应该是一样的；（额外需要说明是，CAP的中C区别于数据库事务ACID中C，指代的是线性一致性，数据库事务中的C适用于理解为逻辑一致性）



 一致性是指写操作后的读操作可以读取到最新的数据状态，当数据分布在多个节点上，从任意结点读取到的数据都是最新的状态。

 上图中，商品信息的读写要满足一致性就是要实现如下目标：

 1、商品服务写入主数据库成功，则向从数据库查询新数据也成功。

 2、商品服务写入主数据库失败，则向从数据库查询新数据也失败。

 如何实现一致性？

 1、写入主数据库后要将数据同步到从数据库。

 2、写入主数据库后，在向从数据库同步期间要将从数据库锁定，待同步完成后再释放锁，以免在新数据写入成功后，向从数据库查询到旧的数据。

 分布式系统一致性的特点：

 1、由于存在数据同步的过程，写操作的响应会有一定的延迟。

 2、为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源。

 3、如果请求数据同步失败的结点则会返回错误信息，一定不会返回旧数据。

 ![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a39458adb8c445282c150135eaa3b33~tplv-k3u1fbpfcp-watermark.image) 



 但是增加节点后，会引入一个新的问题，多个节点中的状态、数据可能并不一致。我们尝试通过各种手段去提升系统各个节点中的`一致性`。最理想的模式就是在每个单一节点对外响应服务之前，如有对于状态、数据变更的操作，全部同步到所有节点后再返回响应给客户端。 



**A - Availability** ：

- A-可用性：挂掉任何一个节点，系统还是可以正常的响应所有外部的访问，不要出现大面积的失败和超时；

 可用性是指任何事务操作都可以得到响应结果，且不会出现响应超时或响应错误。

 上图中，商品信息读取满足可用性就是要实现如下目标：

 1、从数据库接收到数据查询的请求则立即能够响应数据查询结果。

 2、从数据库不允许出现响应超时或响应错误。

 如何实现可用性？

 1、写入主数据库后要将数据同步到从数据库。

 2、由于要保证从数据库的可用性，不可将从数据库中的资源进行锁定。

 3、即时数据还没有同步过来，从数据库也要返回要查询的数据，哪怕是旧数据，如果连旧数据也没有则可以按照约定返回一个默认信息，但不能返回错误或响应超时。

 分布式系统可用性的特点：

 1、 所有请求都有响应，且不会出现响应超时或响应错误。

 ![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47a79a84ed4244199dd5cbf917cd934d~tplv-k3u1fbpfcp-watermark.image) 

 一般来说我们最优先考虑的一定是系统整体的`可用性`，为了提高可用性防止单点故障导致对外的服务不可用，我们会尝试在系统中增加多个节点一同提供服务 



**P - Partition tolerance** ：

- P-分区容错性：节点之间的网络通信断了，整个系统还是可以继续提供服务，而不是直接崩溃。

 通常分布式系统的各各结点部署在不同的子网，这就是网络分区，不可避免的会出现由于网络问题而导致结点之间通信失败，此时仍可对外提供服务，这叫分区容忍性。

 上图中，商品信息读写满足分区容忍性就是要实现如下目标：

 1、主数据库向从数据库同步数据失败不影响读写操作。

 2、其一个结点挂掉不影响另一个结点对外提供服务。

 如何实现分区容忍性？

 1、尽量使用异步取代同步操作，例如使用异步方式将数据从主数据库同步到从数据，这样结点之间能有效的实现松耦合。

 2、添加从数据库结点，其中一个从结点挂掉其它从结点提供服务。

 分布式分区容忍性的特点：

 1、分区容忍性分是布式系统具备的基本能力。

 ![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc146c5ded89489397b69b2b800103ac~tplv-k3u1fbpfcp-watermark.image) 





但是如果网络出现大量的延迟，甚至网络直接产生了分区，隔断了整个将整个系统分为两片。这个时候如果每一个分区都有可能收到来自服务网络区域的请求。在这个时候，如果需要保持系统的`一致性`那么就会应该直接返回失败，而从降低了`可用性`；反之，如果为了`可用性`继续提供服务，那么分区之间的数据在一定时间内是无法达成`一致性`的，客户端在不同网络区域访问同一个系统可能会获取不同的状态和数据。



### 2、CAP组合方式

 1、上边商品管理的例子是否同时具备 CAP呢？

 **在所有分布式事务场景中不会同时具备CAP三个特性，因为在具备了P的前提下C和A是不能共存的。**

 比如：

 下图满足了P即表示实现分区容忍：

 ![img](https://pic3.zhimg.com/80/v2-df21cb43ed0a6148cc69d50bee93b256_720w.jpg) 



本图分区容忍的含义是：

1）主数据库通过网络向从数据同步数据，可以认为主从数据库部署在不同的分区，通过网络进行交互。

2）当主数据库和从数据库之间的网络出现问题不影响主数据库和从数据库对外提供服务。

3）其一个结点挂掉不影响另一个结点对外提供服务。

如果要实现C则必须保证数据一致性，在数据同步的时候为防止向从数据库查询不一致的数据则需要将从数据库数据锁定，待同步完成后解锁，如果同步失败从数据库要返回错误信息或超时信息。

如果要实现A则必须保证数据可用性，不管任何时候都可以向从数据查询数据，则不会响应超时或返回错误信息。

通过分析发现在满足P的前提下C和A存在矛盾性。



2、CAP有哪些组合方式呢？

 所以在生产中对分布式事务处理时要根据需求来确定满足CAP的哪两个方面。

 1）AP：

 放弃一致性，追求分区容忍性和可用性。这是很多分布式系统设计时的选择。

 例如：

 上边的商品管理，完全可以实现AP，前提是只要用户可以接受所查询的到数据在一定时间内不是最新的即可。

 通常实现AP都会保证最终一致性，后面讲的BASE理论就是根据AP来扩展的，一些业务场景 比如：订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。

 2）CP：

 放弃可用性，追求一致性和分区容错性，我们的zookeeper其实就是追求的强一致，又比如跨行转账，一次转账请求要等待双方银行系统都完成整个事务才算完成。

 3）CA：

 放弃分区容忍性，即不进行分区，不考虑由于网络不通或结点挂掉的问题，则可以实现一致性和可用性。那么系统将不是一个标准的分布式系统，我们最常用的关系型数据就满足了CA。



  上边的商品管理，如果要实现CA则架构如下： 

 ![img](https://pic3.zhimg.com/80/v2-78feac488db14b5d5094bdbd145d1742_720w.png) 

 主数据库和从数据库中间不再进行数据同步，数据库可以响应每次的查询请求，通过事务隔离级别实现每个查询请求都可以返回最新的数据。 



### 3、总结

 通过上面我们已经学习了CAP理论的相关知识，CAP是一个已经被证实的理论：一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition tolerance）这三项中的两项。它可以作为我们进行架构设计、技术选型的考量标准。对于多数大型互联网应用的场景，结点众多、部署分散，而且现在的集群规模越来越大，所以节点故障、网络故障是常态，而且要保证服务可用性达到N个9（99.99..%），并要达到良好的响应性能来提高用户体验，因此一般都会做出如下选择：保证P和A，舍弃C强一致，保证最终一致性.

## **权衡**

**在我们架构师开发分布式系统时，是需要根据业务进行权衡的。**在我们大型互联网公司，因为机器数量庞大，网络故障是常态，**一般选择AP原则**，**牺牲掉数据一致性**。（一些金融产品对数据一致性要求很高的，就会选择CP）。小伙伴们会问，那数据很重要啊，不一致那怎么搞？

> 当然有别的方案会保证数据最终一致性，也就是BASE理论的提出，小伙伴们可自行查阅。

我们看看常用的**分布式系统的权衡**：

> 1、Redis中间件 ----> AP
> 2、RocketMQ中间件 -----> AP
> 3、分布式事务-2pc ----> CP
> 4、分布式事务-最大努力尝试 ---> AP
> 5、Eureka ---> AP

小伙伴们看看Mysql是属于什么？

mysql 满足 cap 中哪些

### 结论

那么我们了解到的一个分布式系统是无法同时满足的CAP三个要求的。CAP定理最大的意义可能就是启发各位系统架构师与开发人员如何合理的根据自身系统的特性去平衡CAP。 CAP定理虽然给出了一套不错的方法论，但是我还是建议不要拿了锤子见什么都是钉子，简单的用CAP去理解一些主流软件的方案，比如MySQL在大多数分类中都被归类到了CA系统，但是在应用特定的HA方案下，MySQL一样可以以牺牲部分C的前提下提升P。下面我们将首先带入MySQL的常见部署方案来结合CAP三个特点进行分析。



HA方案

https://juejin.cn/post/6895761455358935053#heading-12

# 二、MySQL关于一致性的取舍

https://juejin.cn/post/6895761455358935053#heading-12



 首先，我们这里讨论的一致性都是分布式系统的一致性。按照分布式系统的一致性，我们可以将一致性简单分为两种：`强一致性`和`弱一致性`。除此之外，我们还常见一个`最终一致性`的词，我们可以先把他归类到`弱一致性`。 

 对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是**强一致性**。如果能容忍后续的部分或者全部访问不到，则是**弱一致性**。如果经过一段时间后要求能访问到更新后的数据，则是最终一致性 



## 弱一致性

所谓弱一致性指的是在数据更新后，如果能容忍后续的访问只能访问到部分或者全部访问不到，则是弱一致性。 弱一致性中最典型的便是`最终一致性`。最常见的最终一致性的场景就是我们的DNS服务。我们在今天提交了一条DNS记录，在当前可能并不会理科全网反映出这条变更，但在72小时之后，全王所有的节点都会反映出这条记录的变更。

## 强一致性

分布式系统中的强一致性又常被称为`原子一致性（Atomic Consistency）`和`线性一致性（Linearizable Consistency）`。强一致性要求 任何一次读都能读到某个数据的最近一次写的数据，并且系统中的所有进程，看到的操作顺序，都和全局时钟下的顺序一致。简单的说就是全部节点的数据状态都一模一样。



## MySQL Replication

MySQL中多节点一致性主要应用便是利用同步（Replication）将数据在集群的多个节点同步、备份，以提高集群数据的可用性。 传统最常见的手段就是同步日志进行同步。 MySQL默认提供的同步模式是异步同步即在单个机器上完成了日志记录后，不确认节点其他机器的响应，先提交事务。然后其他节点自行根据日志同步操作的模式。这种同步模式下，我们经常使用的部方案就是`主从同步`与`多主同步`。



### 主从同步

 ![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b735c5e6370f4dcaa9292dc81cd8bbdc~tplv-k3u1fbpfcp-watermark.image) 




MySQL Replication中Slave节点会启动后关注Master节点的bin-log，一旦发现存在更新，便会将日志拉回自身节点进行重放已达成同步的目的。 在传统的MySQL Replication中Master节点其实并不感知任何Slave机器的存在。只需要在Slave实例上配置需要关注的Master节点的连接信息和日志路径即可。再配合客户端使用`读写分离`模式对数据机型访问，总体上通过牺牲一部分一致性（C）前提的下提高了整体的可用性(A)。同时我们也可以发现如何平衡CAP不仅是服务端的问题，同时也通过调整客户端应用方案进行调整。

### 多主同步

多主同步其实就是多套MySQL实例互为主从的部署模式。想法很美好，但是在实际应用过程中，只有用过的人才知道多主同步能有多坑。首先是主键冲突，因为即使是多主同步，其同步的手段默认还是异步同步（并不是强一致性），所以两个节点中的数据一定会存在一个时间差上有不统一，造成两个Master都提交插入了主键相同的数据，造成冲突。虽然在MySQL 5.7以后的版本中，官方通过增加了`GTID（全局事务ID）`下的同步模式（区别于仅使用bin-log下的同步模式）一定程度上解决了这个问题。但多主模式下，由于两个节点的沟通模式是异步的，还是无法避免在单一节点事务提交后与另一节点造成数据冲突。



### 异步同步模式下的主从模式的优缺点

首先，缺点显而易见，因为采用了异步同步，没有保证强一致性，如有多个节点同时修改（多主模式）会带来大量数据问题。其次，单主模式下一单在主库发生了故障，系统也基本可以默认是不可用了，如果进行主从切换因为一致性的问题又一定会丢失部分数据。最终，多主模式下虽然在一定程度上解决了单点故障的问题（提升了A），但是又引入了网络分区情况下两个Master节点单独提供服务导致的问题（P跪了）。 但该模式下还是有很多可取的优点：

1. 部署容易，成本优势大；
2. 一主多从下只有Master节点提供写服务，从节点可以提供读服务；如部分核心业务对一致性要求高，也可以将对应的读写操作都放在Master节点上进行；
3. Slave节点是通过日志进行同步的，可以只同步部分关心的表操作，Slave节点中的数据可以是Master的子集。并且使用的数据引擎和索引都可以与Master节点不同，可以充分利用这点对Slave上节点做应用场景下的索引和数据引擎优化；





## 小结

我们大致了解了MySQL主要的集中部署模式，从最原始的单例，到一主多从，到多主同步，最后演化成了分布式集群方案。我大致主观的总结了下每种模式下的关键问题。

 ![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bef0616452784edd9c6a29cfce4ae50f~tplv-k3u1fbpfcp-watermark.image) 

### 单例部署->一主多从

为了解决单点I/O压力过大，结合客户端的读写分离方案，提高了系统整体承载压力上限。但是异步同步的方案又引入了系统一致性的问题。同时如果Master节点单点故障，整体系统还是会有一段时间处于不可用的状态。

### 一主多从->多主同步

为了解决一主多从模式下Master节点的单点故障问题，引入了多个Master节点负责。可以通过其他HA方案，同时使多个Master节点同时对外提供服务。但在默认异步同步模式下，每个Master节点在提交事务操作数据时都以自己的状态为准，一旦发生了网络分区的情况，多个Master可能会发生各自维护一个单独数据副本造成数据不一致的问题。

### 多主同步->分布式集群

为了解决多个Master节点操作数据时无法达成一致的问题，引入算法使每个Master在提交事务前与整个网络中其他节点达成`共识`，保证数据在整个网络中的一致性。 同时在网络发生分区时，通过HA或者选举算法避免或降低造成脑裂的问题。

## 最后，还是要吐槽一下，有钱还是真的香!

看完上面的图，结合Oracle的方案来对比一下。

- RAC用于避免单点故障，在集群中冗余实例，提高A；
- SAN来解决多个实例之间的数据的一致性问题，提高C。

最后辅助OGG和ADG的软件来解决跨数据系统、跨网络分区的数据同步问题。 一套方案下来除了贵，不好扩展，好像没有任何毛病。应用开发工程师只需要关心怎么写好代码，架构师只需要关心才能把这套方案的预算合理的编进去。其他什么问题都不用太担心了。

开源方案的确是便宜、好扩展、透明，唯一的缺点大概就是有点费头发。

